// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.12/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/tsSupport/assignHelper ../../../../core/tsSupport/generatorHelper ../../../../core/tsSupport/awaiterHelper ../../../../core/promiseUtils ../../../../geometry/Extent ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/TileInfo ../../engine ../../viewStateUtils ../../tiling/TileInfoView ../../tiling/TileKey".split(" "),function(D,E,u,v,w,l,q,x,y,z,A,p,B,C){var b=x.create(),h=[0,0],r=new C(0,
0,0,0),e={container:null,fetchSource:null,requestUpdate:null,imageMaxWidth:2048,imageMaxHeight:2048,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1};return function(){function g(a){var d=this;this._imagePromise=null;this.hidpi=e.hidpi;this.imageMaxWidth=e.imageMaxWidth;this.imageMaxHeight=e.imageMaxHeight;this.imageRotationSupported=e.imageRotationSupported;this.imageNormalizationSupported=e.imageNormalizationSupported;this.update=l.debounce(function(a){return w(d,void 0,void 0,
function(){var c,d,f,t,b,m,g,e,n,k=this;return v(this,function(F){c=a.state;d=y.getInfo(c.spatialReference);f=this.hidpi?a.pixelRatio:1;if(!a.stationary)return[2];this.imageRotationSupported?(h[0]=c.size[0],h[1]=c.size[1]):p.getOuterSize(h,c);t=Math.floor(h[0]*f)>this.imageMaxWidth||Math.floor(h[1]*f)>this.imageMaxHeight;b=d&&(c.extent.xmin<d.valid[0]||c.extent.xmax>d.valid[1]);m=!this.imageNormalizationSupported&&b;g=!t&&!m;e=this.imageRotationSupported?c.rotation:0;g?this._imagePromise=this._singleExport(c,
h,e,f):(n=Math.min(this.imageMaxWidth,this.imageMaxHeight),m&&(n=Math.min(c.worldScreenWidth,n)),this._imagePromise=this._tiledExport(c,n,e,f));return[2,this._imagePromise.then(function(a){k._imagePromise=null;var c=k.container.children.slice();k.container.removeAllChildren();a.forEach(k.container.addChild,k.container);k.disposeSource&&c.forEach(function(a){k.disposeSource(a.source)},k)}).catch(function(a){k._imagePromise=null;if(!l.isAbortError(a))throw a;})]})})});a=u({},e,a);this.container=a.container;
this.disposeSource=a.disposeSource;this.fetchSource=a.fetchSource;this.requestUpdate=a.requestUpdate;this.imageMaxWidth=a.imageMaxWidth;this.imageMaxHeight=a.imageMaxHeight;this.imageRotationSupported=a.imageRotationSupported;this.imageNormalizationSupported=a.imageNormalizationSupported;this.hidpi=a.hidpi;this.requestUpdate()}g.prototype.destroy=function(){};Object.defineProperty(g.prototype,"updating",{get:function(){return null!==this._imagePromise},enumerable:!0,configurable:!0});g.prototype.updateExports=
function(a){for(var d=0,b=this.container.children;d<b.length;d++){var c=b[d];if(!c.visible||!c.attached)break;a(c)?console.error("ExportStrategy.updateExports doesn't support promise yet"):(c.invalidateTexture(),c.requestRender())}};g.prototype._export=function(a,d,b,c,e){var f=this;return l.resolve().then(function(){return f.fetchSource(a,Math.floor(d*e),Math.floor(b*e),{rotation:c,pixelRatio:e})}).then(function(b){b=new A.Bitmap(b);b.x=a.xmin;b.y=a.ymax;b.resolution=a.width/d;b.rotation=c;b.pixelRatio=
e;return b})};g.prototype._singleExport=function(a,d,e,c){p.getBBox(b,a.center,a.resolution,d);a=new q(b[0],b[1],b[2],b[3],a.spatialReference);return this._export(a,d[0],d[1],e,c).then(function(a){return[a]})};g.prototype._tiledExport=function(a,d,e,c){var g=this,f=z.create({size:d,spatialReference:a.spatialReference,scales:[a.scale]}),h=new B(f),f=h.getTileCoverage(a);if(!f)return null;var m=[];f.forEach(function(f,l,p,n){r.set(f,l,p,n);h.getTileBounds(b,r);f=new q(b[0],b[1],b[2],b[3],a.spatialReference);
m.push(g._export(f,d,d,e,c))});return l.all(m)};return g}()});